name: Build and Push Docker Image

on:
  push:
    tags:
      - "*"  # 当推送 Git 标签时触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 关键：必须先 checkout，且用最新版 + fetch tags
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 必须加，否则 git describe 和 tag 相关变量可能不准

      # 这一步提取所有信息，100% 可靠，永不 mask
      - name: Extract metadata
        id: meta
        run: |
          # 方法1：最推荐，直接用官方上下文（绝不出错）
          FULL_REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          # OWNER=$(echo "$FULL_REPO" | cut -d'/' -f1)
          # REPO="${{ github.repository_name }}"
          REPO=$(echo "$FULL_REPO" | cut -d'/' -f2)
          TAG="${{ github.ref_name }}"                  # tag 推送时就是 v1.2.3
          echo "full_repo=$FULL_REPO"
          echo "owner=$OWNER"
          echo "repo=$REPO"
          echo "tag=$TAG"

          # 方法2：如果你非常不放心官方变量，再用 shell 二次验证（两者一定相等）
          SHELL_REPO=$(basename "${{ github.repository }}")  # 结果和上面 REPO 完全一致
          echo "shell_repo=$SHELL_REPO"

          # 全转小写（Docker/GHCR 必须小写）
          OWNER_LOWER=$(echo "$OWNER" | tr '[:upper:]' '[:lower:]')
          REPO_LOWER=$(echo "$REPO" | tr '[:upper:]' '[:lower:]')
          SHELL_REPO_LOWER=$(echo "$SHELL_REPO" | tr '[:upper:]' '[:lower:]')
          FULL_REPO_LOWER=$(echo "$FULL_REPO" | tr '[:upper:]' '[:lower:]')

          # 安全打印（不会被 mask）
          echo "Image Full: $FULL_REPO_LOWER:$TAG"
          echo "Image Shell: $OWNER_LOWER/$SHELL_REPO_LOWER:$TAG"
          echo "Image Repo: $OWNER_LOWER/$REPO_LOWER:$TAG"

          # Set outputs for the following steps
          echo "full_repo=$FULL_REPO_LOWER" >> $GITHUB_ENV
          echo "owner=$OWNER_LOWER" >> $GITHUB_ENV
          echo "repo=$REPO_LOWER" >> $GITHUB_ENV
          echo "tag=$TAG" >> $GITHUB_ENV
      - name: Build and push
        id: docker
        run: |
          echo "Image full: $full_repo:$tag"
          echo "Image Shell: $owner/$repo:$tag"