name: Build and Push Docker Image

on:
  push:
    tags:
      - "*"  # 当推送 Git 标签时触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 关键：必须先 checkout，且用最新版 + fetch tags
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 必须加，否则 git describe 和 tag 相关变量可能不准

      # 这一步提取所有信息，100% 可靠，永不 mask
      - name: Extract metadata
        id: meta
        run: |
          # 方法1：最推荐，直接用官方上下文（绝不出错）
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.repository_name }}"
          TAG="${{ github.ref_name }}"                  # tag 推送时就是 v1.2.3

          # 方法2：如果你非常不放心官方变量，再用 shell 二次验证（两者一定相等）
          SHELL_REPO=$(basename "${{ github.repository }}")  # 结果和上面 REPO 完全一致

          # 全转小写（Docker/GHCR 必须小写）
          OWNER_LOWER=$(echo "$OWNER" | tr '[:upper:]' '[:lower:]')
          REPO_LOWER=$(echo "$REPO" | tr '[:upper:]' '[:lower:]')

          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "owner_lower=$OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "repo_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # 安全打印（不会被 mask）
          echo "Image: $OWNER_LOWER/$REPO_LOWER:$TAG"